name: Bump version of package

on:
  workflow_dispatch:
    inputs:
      package:
        required: true
        description: "package to bump version"
      version:
        required: true
        description: "new version for package"
      message:
        required: true
        description: "commit msg"
        default: "new upstream version"
      pr_detail:
        required: false
        description: "detailed message, displayed on PR"
        default: "generated by workflow bump_ver"
  workflow_call:
    inputs:
      package:
        required: true
        type: string
        description: "package to bump version"
      version:
        required: true
        type: string
        description: "new version for package"
      message:
        required: true
        type: string
        description: "commit msg"
        default: "new upstream version"
      pr_detail:
        required: false
        description: "detailed message, displayed on PR"
        type: string
        default: "generated by workflow bump_ver"
    secrets:
      GH_APP_PRIVKEY:
        description: "github app privkey"
        required: true

run-name: Bump version of ${{ github.event.inputs.package }} to ${{ github.event.inputs.version }}

jobs:
  checkduplicate:
    runs-on: ubuntu-latest
    outputs:
      check: ${{ steps.check.outputs.isdup }}
    steps:
      - uses: tibdex/github-app-token@v2
        id: gettoken
        with:
          app_id: ${{ vars.GH_APP_ID }}
          private_key: ${{ secrets.GH_APP_PRIVKEY }}
      - id: check
        run: |
          exists_pr=$(gh search prs --repo=eweOS/packages --app eweos-helper --state open -B ${{ github.event.inputs.package }} --match title --json title -t '{{range .}}{{.title}}{{end}}' ${{ github.event.inputs.version }})
          [[ $exists_pr != "[${{ github.event.inputs.package }}] ${{ github.event.inputs.version }}-1"* ]] || (echo "isdup=dup" >> "$GITHUB_OUTPUT")
        env:
          GH_TOKEN: ${{ steps.gettoken.outputs.token }}
  bumpver:
    runs-on: ubuntu-latest
    needs: checkduplicate
    if: needs.checkduplicate.outputs.check != 'dup'
    steps:
      - uses: tibdex/github-app-token@v2
        id: gettoken
        with:
          app_id: ${{ vars.GH_APP_ID }}
          private_key: ${{ secrets.GH_APP_PRIVKEY }}
      - uses: actions/checkout@v4
        with:
          repository: eweOS/packages
          ref: ${{ github.event.inputs.package }}
          path: repo
      - uses: actions/checkout@v4
        with:
          repository: eweOS/packages
          ref: _main
          path: meta
      - name: Set Git Info
        run: |
          cd repo
          git config --global user.name ${{ vars.GH_APP_NAME }}
          git config --global user.email ${{ vars.GH_APP_UID }}+${{ vars.GH_APP_NAME }}[bot]@users.noreply.github.com
      - name: Bump package version and Update Checksums
        run: >-
          docker run
          --rm
          -v $(pwd):/${{ github.workspace }}
          -w ${{ github.workspace }}
          ghcr.io/eweos/docker:master
          bash -c "
          pacman -Sy --noconfirm pacman-contrib git &&
          cd repo &&
          bash ../meta/tools/bump_ver.sh ${{ github.event.inputs.version }} &&
          updpkgsums
          "
      - name: Git Commit
        run: |
          sudo chown $(whoami) -R repo
          cd repo
          git add PKGBUILD
          source PKGBUILD
          COMMITMSG="[`test $pkgbase && echo $pkgbase || echo $pkgname`] $pkgver-$pkgrel: ${{ github.event.inputs.message }}"
          git commit -m "$COMMITMSG"
          echo COMMITMSG="$COMMITMSG" >> $GITHUB_ENV
          git reset --hard HEAD && git clean -df
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        id: cpr
        with:
          path: repo
          token: ${{ steps.gettoken.outputs.token }}
          branch: bumppkgver/${{ github.event.inputs.package }}
          delete-branch: true
          branch-suffix: timestamp
          base: ${{ github.event.inputs.package }}
          push-to-fork: eweOS/.packages-auto
          title: ${{ env.COMMITMSG }}
          body: ${{ github.event.inputs.pr_detail }}
          labels: bump-pkgver,automated
          draft: true
