name: Bump rel version of package

on:
  workflow_dispatch:
    inputs:
      package:
        required: true
        description: 'package to increase rel version'
      reason:
        required: true
        description: 'reason to bump rel version'
        default: 'bump rel version'
  workflow_call:
    inputs:
      package:
        required: true
        type: string
        description: 'package to increase rel version'
      reason:
        required: true
        type: string
        description: 'reason to bump rel version'
        default: 'bump rel version'
      rebuild:
        description: 'rebuild task (autogenerated, DO NOT FILL)'
        type: string
        default: ''
    secrets:
      GH_APP_PRIVKEY:
        description: 'github app privkey'
        required: true

jobs:
  bump:
    runs-on: ubuntu-latest
    steps:
      - uses: tibdex/github-app-token@v2
        id: gettoken
        with: 
          app_id: ${{ vars.GH_APP_ID }}
          private_key: ${{ secrets.GH_APP_PRIVKEY }}
      - uses: actions/checkout@v4
        with:
          repository: eweOS/packages
          ref: ${{ github.event.inputs.package }}
          path: repo
      - uses: actions/checkout@v4
        with:
          repository: eweOS/packages
          ref: _main
          path: meta
      - name: Set Git Info
        run: |
          cd repo
          git config --global user.name ${{ vars.GH_APP_NAME }}
          git config --global user.email ${{ vars.GH_APP_UID }}+${{ vars.GH_APP_NAME }}[bot]@users.noreply.github.com
      - name: Bump Rel Version
        run: |
          cd repo
          bash ../meta/tools/bump_rel.sh
      - name: Git Commit
        run: |
          cd repo
          git add PKGBUILD
          source PKGBUILD
          COMMITMSG="[$pkgname] $pkgver-$pkgrel: ${{ github.event.inputs.reason }}"
          git commit -m "$COMMITMSG"
          echo COMMITMSG="$COMMITMSG" >> $GITHUB_ENV
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        id: cpr
        with:
          path: repo
          token: ${{ steps.gettoken.outputs.token }}
          branch: bumppkgrel/${{ github.event.inputs.package }}
          delete-branch: true
          branch-suffix: timestamp
          base: ${{ github.event.inputs.package }}
          push-to-fork: eweOS/.packages-auto
          title: ${{ env.COMMITMSG }}
          body: "generated by workflow bump_rel"
          labels: bump-pkgrel,automated
      - name: Create or Update Project Card
        if: github.event.inputs.rebuild != ''
        uses: peter-evans/create-or-update-project-card@v2
        with:
          project-location: eweOS
          project-name: ${{ github.event.inputs.rebuild }}
          column-name: Rebuild
          issue-number: ${{ steps.cpr.outputs.pull-request-number }}
